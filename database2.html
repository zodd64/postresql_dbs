Drop table IF EXISTS USERS cascade;
Drop table IF EXISTS MESSAGES cascade;
Drop table IF EXISTS COMENTS cascade;
Drop table IF EXISTS LIKES cascade;
Drop table IF EXISTS OMADA cascade;
Drop table IF EXISTS DIAX_OMADAS cascade;
Drop table IF EXISTS MELOSOMADAS cascade;
Drop table IF EXISTS FOLLOWS cascade;


/* Δημιουργία Πίνακα {ΧΡΗΣΤΗΣ} */
CREATE TABLE USERS(
	ONOMAXEIRISTH VARCHAR(30) NOT NULL,
	ONOMA VARCHAR(60) NOT NULL,
	EPONYMO VARCHAR(120),
	GENOS VARCHAR(20) NOT NULL,
	POLH VARCHAR(60),
	XORA VARCHAR(60) NOT NULL,
	PRIMARY KEY(ONOMAXEIRISTH));

/* Δημιουργία Πίνακα {ΜΗΝΥΜΑ} */
CREATE TABLE MESSAGES(
	SYG_MHNYMATOS VARCHAR(30) NOT NULL,
	KOD_MHNYMATOS INT NOT NULL,
	IDIOKTHTHS_TOIXOY VARCHAR(30) NOT NULL,
	PERIEXOMENO VARCHAR(4000) NOT NULL,
	HMEROMHNIA DATE NOT NULL,
	CHECK (KOD_MHNYMATOS > 0 ),
	PRIMARY KEY (SYG_MHNYMATOS,KOD_MHNYMATOS),
	FOREIGN KEY (SYG_MHNYMATOS) REFERENCES USERS(ONOMAXEIRISTH),
	FOREIGN KEY (IDIOKTHTHS_TOIXOY) REFERENCES USERS(ONOMAXEIRISTH));
	
/* Δημιουργία Πίνακα {ΣΧΟΛΙΟ} */
CREATE TABLE COMENTS(
	SYG_MHNYMATOS VARCHAR(30) NOT NULL,
	KOD_MHNYMATOS INT NOT NULL,
	KOD_SXOLIOU INT NOT NULL,
	SUGGRAFEAS_SXOLIOU VARCHAR(30) NOT NULL,
	KEIMENO_SXOLIOU VARCHAR(4000) NOT NULL,
	HMEROMHNIA DATE NOT NULL,
	CHECK (KOD_MHNYMATOS > 0 ),
	CHECK (KOD_SXOLIOU > 0 ),
	PRIMARY KEY (SYG_MHNYMATOS,KOD_MHNYMATOS,KOD_SXOLIOU),
	FOREIGN KEY (SYG_MHNYMATOS,KOD_MHNYMATOS) REFERENCES MESSAGES(SYG_MHNYMATOS,KOD_MHNYMATOS),
	FOREIGN KEY (SUGGRAFEAS_SXOLIOU) REFERENCES USERS(ONOMAXEIRISTH));
	
/* Δημιουργία Πίνακα {ΑΡΕΣΕΙ} */
CREATE TABLE LIKES(
	ONOMAXEIRISTH VARCHAR(30) NOT NULL,
	SYG_MHNYMATOS VARCHAR(30) NOT NULL,
	KOD_MHNYMATOS INT NOT NULL,
	CHECK (KOD_MHNYMATOS > 0 ),
	PRIMARY KEY (ONOMAXEIRISTH,SYG_MHNYMATOS,KOD_MHNYMATOS),
	FOREIGN KEY (ONOMAXEIRISTH) REFERENCES USERS(ONOMAXEIRISTH),
	FOREIGN KEY (SYG_MHNYMATOS,KOD_MHNYMATOS) REFERENCES MESSAGES(SYG_MHNYMATOS,KOD_MHNYMATOS));

CREATE TABLE OMADA(
	TID INT NOT NULL,
	ONOMAOMADAS VARCHAR(30) NOT NULL,
	WRA VARCHAR(30) NOT NULL,
	HMEROMHNIA DATE NOT NULL,
	PRIMARY KEY(TID));
	
CREATE TABLE DIAX_OMADAS(
	DID INT NOT NULL,
	ONOMAXEIRISTH VARCHAR(30) NOT NULL,
	PRIMARY KEY (DID,ONOMAXEIRISTH),
	FOREIGN KEY (DID) REFERENCES OMADA(TID),
	FOREIGN KEY (ONOMAXEIRISTH) REFERENCES USERS(ONOMAXEIRISTH));

CREATE TABLE MELOSOMADAS(
	MID INT NOT NULL,
	ONOMAXEIRISTH VARCHAR(30) NOT NULL,
	HMEROMHNIA DATE NOT NULL,
	PRIMARY KEY (MID,ONOMAXEIRISTH),
	FOREIGN KEY (MID) REFERENCES OMADA(TID),
	FOREIGN KEY (ONOMAXEIRISTH) REFERENCES USERS(ONOMAXEIRISTH));	
	
CREATE TABLE FOLLOWS(
	FOLLOWER VARCHAR(30) NOT NULL REFERENCES USERS(ONOMAXEIRISTH),
	FOLLOWED VARCHAR(30) NOT NULL REFERENCES USERS(ONOMAXEIRISTH),
	HMEROMHNIA_DESMOU DATE NOT NULL,
	PRIMARY KEY (FOLLOWER,FOLLOWED));
	
/* Εισαγωγή εγγραφών στον Πίνακα {ΧΡΗΣΤΗΣ} */
INSERT INTO USERS VALUES ('demosthenes', 'Δημοσθένης', 'Ακουμιανάκης', 'Άνδρας', 'Ηράκλειο', 'Ελλάς');
INSERT INTO USERS VALUES ('ktistakis', 'Γιώργος', 'Κτιστάκης', 'Άνδρας', 'Ηράκλειο', 'Ελλάς');

/* Εισαγωγή εγγραφών στον Πίνακα {ΦΙΛΟΙ} */
INSERT INTO FOLLOWS VALUES ('demosthenes', 'ktistakis', TO_DATE('16/03/2016', 'dd/mm/yyyy'));

/* Εισαγωγή εγγραφών στον Πίνακα {ΜΗΝΥΜΑ} */
INSERT INTO MESSAGES VALUES ('demosthenes', 1, 'demosthenes', 'Παρακαλώ να ετοιμαστούν οι υπολογιστές του εργαστηρίου 5ΠΚ', TO_DATE('03/03/2021 13:00', 'dd/mm/yyyy'));
INSERT INTO MESSAGES VALUES ('demosthenes', 2, 'demosthenes', 'Τυχόν προβλήματα να μου σταλούν με email', TO_DATE('03/03/2021 13:01', 'dd/mm/yyyy'));
INSERT INTO MESSAGES VALUES ('ktistakis', 1, 'ktistakis', 'Οι φοιτητές θα πρέπει να χρησιμοποιήσουν τον κωδικό 1234 για πρόσβαση στην PostgreSQL', TO_DATE('03/03/2021 13:05', 'dd/mm/yyyy'));

/* Εισαγωγή εγγραφών στον Πίνακα {ΣΧΟΛΙΟ} */
INSERT INTO COMENTS VALUES ('demosthenes', 1, 1, 'ktistakis',
'Εχω ήδη εγκαταστήσει την PostgreSQL σε όλους τους υπολογιστές',
TO_DATE('03/03/2021 18:10', 'dd/mm/yyyy'));
INSERT INTO COMENTS VALUES ('demosthenes', 1, 2, 'demosthenes',
'Ωραία, ελπίζω να πάνε όλα καλά',
TO_DATE('03/03/2021 18:10', 'dd/mm/yyyy'));
INSERT INTO COMENTS VALUES ('demosthenes', 1, 3, 'demosthenes',
'Επίσης να τονίσω ότι θα χρειαστούμε βοήθεια με τον προτζέκτορα',
TO_DATE('03/03/2021 18:10', 'dd/mm/yyyy'));
INSERT INTO COMENTS VALUES ('ktistakis', 1, 1, 'demosthenes',
'Είναι το ίδιο με το περσυνό. Μήπως να το αλλάξουμε?',
TO_DATE('03/03/2021 18:10', 'dd/mm/yyyy'));
INSERT INTO COMENTS VALUES ('ktistakis', 1, 2, 'ktistakis',
'OK. Ας το κάνουμε 4321',
TO_DATE('03/03/2021 18:10', 'dd/mm/yyyy'));
INSERT INTO COMENTS VALUES ('demosthenes', 2, 1, 'demosthenes',
'Παρακαλώ χρησιμοποιήστε το gmail μου',
TO_DATE('03/03/2021 18:10', 'dd/mm/yyyy'));


/* Εισαγωγή εγγραφών στον Πίνακα {ΑΡΕΣΕΙ} */
INSERT INTO LIKES VALUES ('ktistakis', 'demosthenes', 1);
/*INSERT INTO LIKES VALUES ('ktistakis', 'ktistakis', 2);*/

/* Εισαγωγή εγγραφών στον Πίνακα {ΟΜΑΔΑ} */
INSERT INTO OMADA VALUES (1, 'Εργαστηριακή ομάδα 1', '13.00-15.00', TO_DATE('03/03/2021', 'dd/mm/yyyy'));
INSERT INTO OMADA VALUES (2, 'Εργαστηριακή ομάδα 2', '15.00-17.00', TO_DATE('03/03/2021', 'dd/mm/yyyy'));

/* Εισαγωγή εγγραφών στον Πίνακα {ΔΙΑΧΕΙΡΟΜΑΔΑΣ} */
INSERT INTO DIAX_OMADAS VALUES (1, 'demosthenes');
INSERT INTO DIAX_OMADAS VALUES (2, 'demosthenes');

/* Εισαγωγή εγγραφών στον Πίνακα {ΜΕΛΟΣΟΜΑΔΑΣ} */
INSERT INTO MELOSOMADAS VALUES (1, 'ktistakis', TO_DATE('03/03/2021', 'dd/mm/yyyy'));
INSERT INTO MELOSOMADAS VALUES (2, 'ktistakis', TO_DATE('03/03/2021', 'dd/mm/yyyy'));

/* QUERIES */

/* 1 */
SELECT * FROM USERS WHERE POLH = 'Ηράκλειο' AND XORA = 'Ελλάς';
/* 2 */
SELECT COUNT(*)
FROM COMENTS,USERS 
WHERE POLH = 'Ηράκλειο' AND XORA = 'Ελλάς' AND SYG_MHNYMATOS=ONOMAXEIRISTH;
/* 3 */
SELECT COUNT(*)
FROM COMENTS,USERS 
WHERE NOT XORA = 'Ελλάς' AND SYG_MHNYMATOS=ONOMAXEIRISTH;
/* 4 */
SELECT SYG_MHNYMATOS,PERIEXOMENO,HMEROMHNIA FROM MESSAGES ORDER BY HMEROMHNIA desc LIMIT 1;
/* 5 */
SELECT ONOMAXEIRISTH,ONOMAOMADAS FROM DIAX_OMADAS,OMADA WHERE TID = DID;
/* 6 */
SELECT ONOMA,EPONYMO,ONOMAXEIRISTH FROM USERS NATURAL JOIN DIAX_OMADAS
GROUP BY ONOMAXEIRISTH
ORDER BY COUNT(ONOMAXEIRISTH) desc LIMIT 1;
/* 7 */
SELECT SYG_MHNYMATOS,KOD_MHNYMATOS,PERIEXOMENO,COUNT(*) FROM MESSAGES NATURAL JOIN LIKES
GROUP BY SYG_MHNYMATOS,KOD_MHNYMATOS
ORDER BY COUNT(*) DESC;
/* 8 */
SELECT SYG_MHNYMATOS,PERIEXOMENO,SUGGRAFEAS_SXOLIOU,KEIMENO_SXOLIOU,HMEROMHNIA 
FROM MESSAGES NATURAL JOIN COMENTS;
/* 9 */
SELECT SUGGRAFEAS_SXOLIOU,HMEROMHNIA
FROM COMENTS WHERE SYG_MHNYMATOS = 'demosthenes';
/* 10 */
SELECT USERS.* FROM USERS,FOLLOWS WHERE NOT ONOMAXEIRISTH = FOLLOWER;
/* 11 */
SELECT SYG_MHNYMATOS,KOD_MHNYMATOS,COUNT(*) FROM COMENTS
GROUP BY SYG_MHNYMATOS,KOD_MHNYMATOS;
/* 12 */
SELECT FOLLOWED,COUNT(*) FROM FOLLOWS
GROUP BY FOLLOWED
ORDER BY COUNT(*) DESC LIMIT 1;